<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMTOCS - Tagihan Listrik Toko</title>
    <script async src="https://apis.google.com/js/api.js"></script>
    <script async src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #FF69B4 0%, #4A90E2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .controls { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .content { padding: 20px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        tr:hover { background: #f5f5f5; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .loading { text-align: center; padding: 40px; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-card h3 { color: #FF69B4; margin-bottom: 5px; }
        .currency { text-align: right; }
        .number { text-align: right; }
        @media (max-width: 768px) { .controls { flex-direction: column; } .btn { width: 100%; } }
    </style>
</head>
<body>
    <div id="logout-warning" class="modal">
        <div class="modal-content">
            <h2>Sesi Anda akan berakhir!</h2>
            <p>Sesi Anda akan berakhir dalam <span id="countdown-timer">60</span> detik karena tidak ada aktivitas. Klik di mana saja untuk melanjutkan.</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>‚ö° SIMTOCS - Tagihan Listrik Toko</h1>
            <p>Monitoring Penggunaan dan Biaya Listrik</p>
            <div id="user-bar" style="display: none;">
                <p>Selamat datang, <span id="user-name"></span>! (<span id="user-role"></span>)</p>
                <button onclick="handleAuthClick()" class="btn btn-danger">Logout</button>
            </div>
            <div id="login-bar">
                <button onclick="handleAuthClick()" class="btn btn-primary">Login dengan Google</button>
            </div>
        </div>
        
        <div class="controls">
            <a href="index.html" class="btn btn-primary">üè† Dashboard</a>
            <select id="monthSelect" onchange="handleMonthChange()">
                <option value="">Pilih Bulan...</option>
                <option value="Informasi_Umum">Informasi Umum</option>
                <option value="Januari_2025">Januari 2025</option>
                <option value="Februari_2025">Februari 2025</option>
                <option value="Maret_2025">Maret 2025</option>
                <option value="April_2025">April 2025</option>
                <option value="Mei_2025">Mei 2025</option>
                <option value="Juni_2025">Juni 2025</option>
                <option value="Juli_2025">Juli 2025</option>
                <option value="Agustus_2025">Agustus 2025</option>
                <option value="September_2025">September 2025</option>
                <option value="Oktober_2025">Oktober 2025</option>
                <option value="November_2025">November 2025</option>
                <option value="Desember_2025">Desember 2025</option>
            </select>
            <button class="btn btn-success" onclick="openAddModal()" id="addBtn" style="display: none;">‚ûï Tambah Data</button>
            <button class="btn btn-warning" onclick="handleRefresh()">üîÑ Refresh</button>
        </div>
        
        <div class="content" id="content">
            <div class="empty-state">
                <h2>Pilih Bulan untuk Melihat Data</h2>
                <p>Gunakan dropdown di atas untuk memilih bulan yang ingin ditampilkan</p>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tambah Data Baru</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="dataForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="editRowIndex" value="">
                
                <div class="form-group">
                    <label for="nomor">No *</label>
                    <input type="number" id="nomor" placeholder="Nomor urut" required>
                </div>
                
                <div class="form-group">
                    <label for="namaToko">Nama Toko *</label>
                    <input type="text" id="namaToko" placeholder="Nama toko" required>
                </div>

                <div class="form-group" id="idPelangganGroup">
                    <label for="idPelanggan">ID Pelanggan</label>
                    <input type="text" id="idPelanggan" placeholder="ID Pelanggan PLN">
                </div>

                <div class="form-group billing-fields">
                    <label for="standAwal">Stand Awal *</label>
                    <input type="number" id="standAwal" placeholder="0" required oninput="calculateUsage()">
                </div>

                <div class="form-group billing-fields">
                    <label for="standAkhir">Stand Akhir *</label>
                    <input type="number" id="standAkhir" placeholder="0" required oninput="calculateUsage()">
                </div>

                <div class="form-group billing-fields">
                    <label for="penggunaan">Penggunaan (kWh)</label>
                    <input type="number" id="penggunaan" placeholder="Otomatis dihitung" readonly style="background: #e9ecef;">
                </div>

                <div class="form-group billing-fields">
                    <label for="biaya">Biaya Listrik *</label>
                    <input type="number" id="biaya" placeholder="0" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Simpan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION & INACTIVITY ---
        let inactivityTimer;
        let logoutWarningTimer;

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            hideLogoutWarning();
            inactivityTimer = setTimeout(showLogoutWarning, 5 * 60 * 1000); // 5 minutes
        }

        function showLogoutWarning() {
            const warningModal = document.getElementById('logout-warning');
            warningModal.classList.add('active');
            let countdown = 60;
            document.getElementById('countdown-timer').textContent = countdown;

            logoutWarningTimer = setInterval(() => {
                countdown--;
                document.getElementById('countdown-timer').textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(logoutWarningTimer);
                    handleLogout();
                }
            }, 1000);
        }

        function hideLogoutWarning() {
            const warningModal = document.getElementById('logout-warning');
            warningModal.classList.remove('active');
            clearInterval(logoutWarningTimer);
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    localStorage.removeItem('gAuthToken');
                    updateUiForLoggedOutState();
                });
            }
        }

        function updateUiForLoggedInState(profile) {
            document.getElementById('login-bar').style.display = 'none';
            document.getElementById('user-bar').style.display = 'block';
            document.getElementById('user-name').textContent = profile.getName();
            document.getElementById('user-role').textContent = localStorage.getItem('userRole') || 'User';
            resetInactivityTimer();
        }

        function updateUiForLoggedOutState() {
            document.getElementById('login-bar').style.display = 'block';
            document.getElementById('user-bar').style.display = 'none';
            document.getElementById('content').innerHTML = '<div class="empty-state"><h2>Silakan login untuk melihat data.</h2></div>';
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
        }

        // --- GOOGLE API & OAUTH ---
        const CONFIG = {
            CLIENT_ID: '''874016971039-g91m2mt64mid7sh9vkk14vpjmpbc095o.apps.googleusercontent.com''',
            API_KEY: '''AIzaSyCMpk-2HdASd6oX-MBRqehgXX-kTfzpFw0''',
            SPREADSHEET_ID: '''11mcPMAfI30QJNI5Vp9M5XW2kyglLVsfRkC2uFNDD1sQ''',
            SCOPES: '''https://www.googleapis.com/auth/spreadsheets'''
        };

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['''https://sheets.googleapis.com/$discovery/rest?version=v4'''],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const token = JSON.parse(localStorage.getItem('gAuthToken'));
                if (token && token.expires_at > Date.now()) {
                    gapi.client.setToken(token);
                    // You might want to fetch profile info here
                    updateUiForLoggedInState({ getName: () => 'User' });
                }
            }
        }

        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    const token = gapi.client.getToken();
                    token.expires_at = Date.now() + (token.expires_in * 1000);
                    localStorage.setItem('gAuthToken', JSON.stringify(token));
                    // You might want to fetch profile info here
                    updateUiForLoggedInState({ getName: () => 'User' });
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                }
            } else {
                handleLogout();
            }
        }

        // --- APP LOGIC ---
        let appState = {
            currentMonth: null,
            currentData: [],
        };

        // Utility functions
        function formatRupiah(value) {
            if (!value && value !== 0) return 'Rp0';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^\d.-]/g, '')) : value;
            if (isNaN(num)) return 'Rp0';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        function formatNumber(value) {
            if (!value) return '-';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^\d.-]/g, '')) : value;
            if (isNaN(num)) return value;
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function parseNumber(value) {
            if (!value) return 0;
            const str = value.toString().replace(/[^\d.-]/g, '');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        // UI functions
        function showLoading(message = 'Memuat data...') {
            document.getElementById('content').innerHTML = `<div class="loading"><h3>${message}</h3></div>`;
        }

        function showError(message) {
            document.getElementById('content').innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        function showEmptyState() {
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <h2>Pilih Bulan untuk Melihat Data</h2>
                    <p>Gunakan dropdown di atas untuk memilih bulan yang ingin ditampilkan</p>
                </div>
            `;
        }

        // Modal functions
        function openAddModal() {
            if (!appState.currentMonth) {
                alert('Pilih bulan terlebih dahulu!');
                return;
            }

            const isInfoMode = appState.currentMonth === 'Informasi_Umum';
            
            document.getElementById('modalTitle').textContent = 'Tambah Data Baru';
            document.getElementById('editRowIndex').value = '';
            document.getElementById('dataForm').reset();
            
            const billingFields = document.querySelectorAll('.billing-fields');
            billingFields.forEach(field => {
                field.style.display = isInfoMode ? 'none' : 'block';
            });
            
            document.getElementById('dataModal').classList.add('active');
        }

        function openEditModal(rowIndex) {
            if (!appState.currentData || appState.currentData.length < rowIndex) {
                alert('Data tidak ditemukan!');
                return;
            }

            const row = appState.currentData[rowIndex - 1];
            const isInfoMode = appState.currentMonth === 'Informasi_Umum';
            
            document.getElementById('modalTitle').textContent = 'Edit Data';
            document.getElementById('editRowIndex').value = rowIndex;
            
            const billingFields = document.querySelectorAll('.billing-fields');
            billingFields.forEach(field => {
                field.style.display = isInfoMode ? 'none' : 'block';
            });
            
            document.getElementById('nomor').value = row[0] || '';
            document.getElementById('namaToko').value = row[1] || '';
            document.getElementById('idPelanggan').value = row[2] || '';
            
            if (!isInfoMode) {
                document.getElementById('standAwal').value = parseNumber(row[3]);
                document.getElementById('standAkhir').value = parseNumber(row[4]);
                document.getElementById('biaya').value = parseNumber(row[6]);
                calculateUsage();
            }
            
            document.getElementById('dataModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('dataModal').classList.remove('active');
            document.getElementById('dataForm').reset();
        }

        function calculateUsage() {
            const standAwal = parseNumber(document.getElementById('standAwal').value) || 0;
            const standAkhir = parseNumber(document.getElementById('standAkhir').value) || 0;
            const penggunaan = standAkhir - standAwal;
            document.getElementById('penggunaan').value = penggunaan >= 0 ? penggunaan : 0;
        }

        // Data functions
        async function handleMonthChange() {
            const monthSelect = document.getElementById('monthSelect');
            const selectedMonth = monthSelect.value;
            
            if (selectedMonth) {
                await loadMonthData(selectedMonth);
            } else {
                showEmptyState();
            }
        }

        async function handleRefresh() {
            const monthSelect = document.getElementById('monthSelect');
            const selectedMonth = monthSelect.value;
            
            if (!selectedMonth) {
                alert('Pilih bulan terlebih dahulu');
                return;
            }
            
            await loadMonthData(selectedMonth);
        }

        async function handleDelete(rowIndex) {
            if (!confirm('‚ö†Ô∏è Yakin ingin menghapus data ini?')) return;
            
            showLoading('Menghapus data...');
            try {
                const range = `${appState.currentMonth}!A${rowIndex + 1}:Z${rowIndex + 1}`;
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: range,
                });
                await handleRefresh();
                alert('‚úÖ Data berhasil dihapus!');
            } catch (err) {
                showError('Gagal menghapus data: ' + err.message);
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const nomor = document.getElementById('nomor').value;
            const namaToko = document.getElementById('namaToko').value;
            const idPelanggan = document.getElementById('idPelanggan').value;
            const editRowIndex = document.getElementById('editRowIndex').value;
            const isInfoMode = appState.currentMonth === 'Informasi_Umum';
            
            let values;
            
            if (isInfoMode) {
                values = [[nomor, namaToko, idPelanggan]];
            } else {
                const standAwal = parseNumber(document.getElementById('standAwal').value);
                const standAkhir = parseNumber(document.getElementById('standAkhir').value);
                const penggunaan = parseNumber(document.getElementById('penggunaan').value);
                const biaya = parseNumber(document.getElementById('biaya').value);
                
                values = [[nomor, namaToko, idPelanggan, standAwal, standAkhir, penggunaan, biaya]];
            }
            
            showLoading('Menyimpan data...');
            try {
                if (editRowIndex) {
                    const range = `${appState.currentMonth}!A${parseInt(editRowIndex) + 1}`;
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: range,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: values },
                    });
                } else {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: appState.currentMonth,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: values },
                    });
                }
                await handleRefresh();
                closeModal();
                alert('‚úÖ Data berhasil disimpan!');
            } catch (err) {
                showError('Gagal menyimpan data: ' + err.message);
            }
        }

        function renderTable(data) {
            const isInfoMode = appState.currentMonth === 'Informasi_Umum';
            
            let html = '<div class="table-container"><table>';
            
            if (isInfoMode) {
                html += '<thead><tr><th>No</th><th>Nama Toko</th><th>ID Pelanggan</th><th>Aksi</th></tr></thead>';
            } else {
                html += '<thead><tr><th>No</th><th>Nama Toko</th><th>ID Pelanggan</th><th>Stand Awal</th><th>Stand Akhir</th><th>Penggunaan</th><th>Biaya</th><th>Aksi</th></tr></thead>';
            }
            
            html += '<tbody>';
            let totalBiaya = 0;
            
            data.forEach((row, index) => {
                html += '<tr>';
                html += `<td>${row[0] || ''}</td>`;
                html += `<td>${row[1] || ''}</td>`;
                html += `<td>${row[2] || ''}</td>`;
                
                if (!isInfoMode) {
                    html += `<td class="number">${formatNumber(row[3])}</td>`;
                    html += `<td class="number">${formatNumber(row[4])}</td>`;
                    html += `<td class="number">${formatNumber(row[5])}</td>`;
                    html += `<td class="currency">${formatRupiah(row[6])}</td>`;
                    totalBiaya += parseNumber(row[6]);
                }
                
                html += `<td>
                    <button class="btn btn-primary" onclick="openEditModal(${index + 1})">Edit</button>
                    <button class="btn btn-danger" onclick="handleDelete(${index + 1})">Hapus</button>
                </td>`;
                html += '</tr>';
            });
            
            if (!isInfoMode && data.length > 0) {
                html += `<tr style="background: #e8f5e8; font-weight: bold;"><td colspan="6">TOTAL</td><td class="currency">${formatRupiah(totalBiaya)}</td><td></td></tr>`;
            }
            
            html += '</tbody></table></div>';
            
            if (isInfoMode) {
                html += '<div class="stats">';
                html += `<div class="stat-card"><h3>${data.length}</h3><p>Total Toko</p></div>';
                html += `<div class="stat-card"><h3>${data.filter(r => r[2]).length}</h3><p>Toko dengan ID Pelanggan</p></div>';
                html += '</div>';
            }
            
            document.getElementById('content').innerHTML = html;
            document.getElementById('addBtn').style.display = 'inline-block';
        }

        async function loadMonthData(monthName) {
            showLoading();
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: monthName,
                });
                appState.currentMonth = monthName;
                appState.currentData = response.result.values || [];
                if (appState.currentData.length > 0) {
                    renderTable(appState.currentData);
                } else {
                    document.getElementById('content').innerHTML = '<div class="empty-state"><h2>Tidak ada data untuk bulan ini</h2></div>';
                }
            } catch (err) {
                showError('Gagal memuat data: ' + err.result.error.message);
            }
        }

        // Event listeners
        window.onclick = function(event) {
            const modal = document.getElementById('dataModal');
            if (event.target === modal) {
                closeModal();
            }
            resetInactivityTimer();
        };
        document.onmousemove = resetInactivityTimer;
        document.onkeypress = resetInactivityTimer;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            gapiLoaded();
            gisLoaded();
        });
    </script>
</body>
</html>
